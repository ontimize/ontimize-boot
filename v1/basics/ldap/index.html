<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>LDAP Security - Ontimize Boot</title>
<meta name="description" content="">


  <meta name="author" content="Imatia Innovation, S.L.">
  


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Ontimize Boot">
<meta property="og:title" content="LDAP Security">
<meta property="og:url" content="https://ontimize.github.io/ontimize-boot/v1/basics/ldap/">


  <meta property="og:description" content="">











  

  


<link rel="canonical" href="https://ontimize.github.io/ontimize-boot/v1/basics/ldap/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Imatia Innovation, S.L",
      "url": "https://ontimize.github.io/ontimize-boot/v1/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/ontimize-boot/v1/feed.xml" type="application/atom+xml" rel="alternate" title="Ontimize Boot Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>


<!-- For all browsers -->
<link rel="stylesheet" href="/ontimize-boot/v1/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">
<link rel="stylesheet" href="/ontimize-boot/v1/assets/css/jstreestyle.css"/>

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/ontimize-boot/v1/assets/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/ontimize-boot/v1/assets/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/ontimize-boot/v1/assets/images/favicon-16x16.png">
<link rel="mask-icon" href="/ontimize-boot/v1/assets/images/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/ontimize-boot/v1/assets/images/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/ontimize-boot/v1/assets/images/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ontimize-boot/v1/"><img src="/ontimize-boot/v1/assets/images/logo-ontimize.png" alt=""></a>
        
        <a class="site-title" href="/ontimize-boot/v1/">
           
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="https://ontimize.github.io/docs/v1/">Ontimize Docs</a>
            </li>
          <li class="masthead__menu-item">
            <select class="masthead__menu-item-combo" onchange="window.location = this.options[this.selectedIndex].value">
            
              <option value="https://ontimize.github.io/ontimize-boot/v1" selected>1.x.x</option>
            
              <option value="https://ontimize.github.io/ontimize-boot">3.x.x</option>
            
            </select>
          </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://ontimize.github.io/ontimize-boot/v1/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ontimize-boot/v1/basics" itemprop="item"><span itemprop="name">Basics</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">LDAP Security</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="LDAP Security">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">LDAP Security
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li>
<a href="#steps">Steps</a>
    <ul>
      <li>
<a href="#database">Database</a>
        <ul>
          <li><a href="#add-a-new-user">Add a new user</a></li>
        </ul>
      </li>
      <li>
<a href="#autoconfigurators">Autoconfigurators</a>
        <ul>
          <li><a href="#add-ldap-autoconfigurators">Add LDAP autoconfigurators</a></li>
        </ul>
      </li>
      <li>
<a href="#modify-applicationyml">Modify application.yml</a>
        <ul>
          <li><a href="#add-ldap-properties">Add LDAP properties</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction">Introduction</h1>

<p>The <strong>L</strong>ightweight <strong>D</strong>irectory <strong>A</strong>ccess <strong>P</strong>rotocol (<strong>LDAP</strong>) is an open protocol for accessing a companyâ€™s information services. Typically, this protocol is used to provide all company users with an easy way to use all services that require access credentials with a single username and password.</p>

<h1 id="prerequisites">Prerequisites</h1>

<p>You can follow this tutorial using your own application, although for this example we will use an application created using the archetype that can be found <a href="https://ontimize.github.io/ontimize-boot/v1/getting_started/">on this page</a> and with a REST service.</p>

<p>There are 2 options to follow this tutorial, clone the repository with the initial state and follow the tutorial step by step, or download the final example and see which files are new and which have been updated.</p>

<div class="multiColumnRow multiColumnRowJustify">
<div class="multiColumn multiColumnGrow">
  <p><strong>Initial project</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/$ git clone https://github.com/ontimize/ontimize-examples 
/ontimize-examples$ cd ontimize-examples
/ontimize-examples$ git checkout boot-ldap-login-1.x.x-initial
</code></pre></div></div>

</div>
<div class="verticalDivider"></div>
<div class="multiColumn multiColumnGrow">

  <p><strong>Final example</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/$ git clone https://github.com/ontimize/ontimize-examples 
/ontimize-examples$ cd ontimize-examples
/ontimize-examples$ git checkout boot-ldap-login-1.x.x
</code></pre></div></div>


</div>
</div>

<h1 id="steps">Steps</h1>

<h2 id="database">Database</h2>

<h3 id="add-a-new-user">Add a new user</h3>

<p>With the database started, we create a new user with the same username that we have registered in the domain. When we try to login we need to use the password of the domain, not the password that inserts into the database. Then, we need to bind this new user with an existing role.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
</pre></td>
<td class="code"><pre><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">TUSER</span> <span class="p">(</span><span class="n">USER_</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="n">SURNAME</span><span class="p">,</span> <span class="n">EMAIL</span><span class="p">,</span> <span class="n">NIF</span><span class="p">,</span> <span class="n">USERBLOCKED</span><span class="p">,</span> <span class="n">LASTPASSWORDUPDATE</span><span class="p">,</span> <span class="n">FIRSTLOGIN</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'domain.username'</span><span class="p">,</span> <span class="s1">'somepassword'</span><span class="p">,</span> <span class="s1">'Name'</span><span class="p">,</span> <span class="s1">'Surname'</span><span class="p">,</span> <span class="s1">'Email'</span><span class="p">,</span> <span class="s1">'Nif'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
</pre></td>
<td class="code"><pre><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">TUSER_ROLE</span> <span class="p">(</span><span class="n">ID_ROLENAME</span><span class="p">,</span><span class="n">USER_</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'domain.username'</span><span class="p">);</span>
</pre></td>
</tr></tbody></table></code></pre></figure>

<h2 id="autoconfigurators">Autoconfigurators</h2>

<h3 id="add-ldap-autoconfigurators">Add LDAP autoconfigurators</h3>

<div class="multiColumnRow">
<div class="multiColumn jstreeloader">
<ul>
  <li data-jstree='{"opened":true, "icon":"fas fa-folder-open"}'>
  ontimize-examples
  <ul>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-api
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  api
                  <ul>
                    <li data-jstree='{"icon":"fas fa-folder-open"}'>
                    core
                    <ul>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      service
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>IUserService.java</li>
                      </ul>
                      </li>
                    </ul>
                    </li>
                  </ul>
                  </li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-boot
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  security
                  <ul>
                    <li data-jstree='{"selected": true, "icon":"fas fa-file"}'>CustomSecurityAutoConfiguration.java</li>
                    <li data-jstree='{"selected": true, "icon":"fas fa-file"}'>LdapAuthenticationMechanism.java</li>
                    <li data-jstree='{"selected": true, "icon":"fas fa-file"}'>LdapError.java</li>
                  </ul>
                  </li>
                  <li data-jstree='{"icon":"fas fa-file"}'>ServerApplication.java</li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          resources
          <ul>
            <li data-jstree='{"icon":"fas fa-file"}'>application.yml</li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-model
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          db
          <ul>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.properties</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.script</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.txt</li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  model
                  <ul>
                    <li data-jstree='{"icon":"fas fa-folder-open"}'>
                    core
                    <ul>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      dao
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserDao.java</li>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserRoleDao.java</li>
                      </ul>
                      </li>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      service
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserService.java</li>
                      </ul>
                      </li>
                    </ul>
                    </li>
                  </ul>
                  </li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          resources
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            dao
            <ul>
              <li data-jstree='{"icon":"fas fa-file"}'>placeholders.properties</li>
              <li data-jstree='{"icon":"fas fa-file"}'>RoleDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>RoleServerPermissionDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>ServerPermissionDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>UserDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>UserRoleDao.xml</li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-ws
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  ws
                  <ul>
                    <li data-jstree='{"icon":"fas fa-folder-open"}'>
                    core
                    <ul>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      rest
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>MainRestController.java</li>
                        <li data-jstree='{"icon":"fas fa-file"}'>TestRestController.java</li>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserRestController.java</li>
                      </ul>
                      </li>
                    </ul>
                    </li>
                  </ul>
                  </li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-file"}'>.gitignore</li>
    <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    <li data-jstree='{"icon":"fas fa-file"}'>README.md</li>
  </ul>
  </li>
</ul>
</div>
<div class="multiColumn multiColumnGrow">

  <p><strong>LdapError.java</strong></p>



<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.ontimize.projectwiki.security</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LdapError</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">NO_LDAP_CONNECTION</span> <span class="o">=</span> <span class="s">"NO_CONNECT_TO_LDAP"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ERROR_SEARCHING_IN_LDAP</span> <span class="o">=</span> <span class="s">"ERROR_SEARCHING_IN_LDAP"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ERROR_LOGIN_LDAP</span> <span class="o">=</span> <span class="s">"LOGINEXCEPTION_WITH_LDAP"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ERROR_IO_LDAP</span> <span class="o">=</span> <span class="s">"IOEXCEPTION_WITH_LDAP"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EMPTY_LDAP_HOST</span> <span class="o">=</span> <span class="s">"HOST_CANNOT_BE_EMPTY"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EMPTY_LDAP_USER</span> <span class="o">=</span> <span class="s">"USER_CANNOT_BE_EMPTY"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EMPTY_LDAP_PASSWORD</span> <span class="o">=</span> <span class="s">"PASSWORD_CANNOT_BE_EMPTY"</span><span class="o">;;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LDAP_AUTH_USER_PASS_NOT_VALID</span> <span class="o">=</span> <span class="s">"LDAP_CREDENTIALS_NOT_VALID"</span><span class="o">;</span>

<span class="o">}</span></code></pre></figure>

  <p><strong>LdapAuthenticationMechanism.java</strong></p>



<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.ontimize.projectwiki.security</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.UnsupportedEncodingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.StringTokenizer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.naming.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.NamingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.directory.DirContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.directory.InitialDirContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.security.auth.login.LoginException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.aspectj.weaver.Utils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AuthenticationManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.BadCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.codec.Base64</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.ontimize.jee.server.security.authentication.AuthenticationResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ontimize.jee.server.security.authentication.IAuthenticationMechanism</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ontimize.jee.server.security.authentication.OntimizeAuthenticationProvider</span><span class="o">;</span>

<span class="nd">@Component</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LdapAuthenticationMechanism</span> <span class="kd">implements</span> <span class="nc">IAuthenticationMechanism</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOGGER</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LdapAuthenticationMechanism</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">credentialsCharset</span> <span class="o">=</span> <span class="s">"UTF-8"</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${ldap.host}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">ldapHost</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${ldap.port}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">ldapPort</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${ldap.loginType}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">loginType</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${ldap.bind.dn}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">ldapBindDn</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${ldap.domain}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">ldapDomain</span><span class="o">;</span>

	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${ldap.base.dn}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">ldapBaseDn</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">AuthenticationResult</span> <span class="nf">authenticate</span><span class="o">(</span><span class="kd">final</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>

			<span class="kd">final</span> <span class="nc">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">)</span> <span class="o">{</span>

		<span class="k">try</span> <span class="o">{</span>

			<span class="kd">final</span> <span class="nc">String</span> <span class="n">header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">header</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">header</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"Basic "</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">tokens</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">extractAndDecodeHeader</span><span class="o">(</span><span class="n">header</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
			<span class="k">assert</span> <span class="n">tokens</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">2</span><span class="o">;</span>
			<span class="kd">final</span> <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
			<span class="kd">final</span> <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>

			<span class="nc">LdapAuthenticationMechanism</span><span class="o">.</span><span class="na">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Validating access for user : '{}'"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>

			<span class="nc">DirContext</span> <span class="n">dirContext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">loginType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"DN"</span><span class="o">))</span> <span class="o">{</span>
				<span class="nc">String</span> <span class="n">userDn</span> <span class="o">=</span> <span class="s">"uid="</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">ldapBindDn</span><span class="o">;</span>
				<span class="n">dirContext</span> <span class="o">=</span> <span class="n">connect</span><span class="o">(</span><span class="n">userDn</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">ldapHost</span><span class="o">,</span> <span class="n">ldapPort</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">loginType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"simple"</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">dirContext</span> <span class="o">=</span> <span class="n">connect</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">ldapHost</span><span class="o">,</span> <span class="n">ldapPort</span><span class="o">,</span> <span class="n">ldapDomain</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">dirContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="k">new</span> <span class="nf">AuthenticationResult</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span>
						<span class="nc">OntimizeAuthenticationProvider</span><span class="o">.</span><span class="na">NO_AUTHENTICATION_TOKEN</span><span class="o">));</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"System authentication failed: no connect to LDAP"</span><span class="o">);</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">NO_LDAP_CONNECTION</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"System authentication failed: NamingException searching into server LDAP"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">ERROR_SEARCHING_IN_LDAP</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">LoginException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"System authentication failed: LoginException with server LDAP"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">ERROR_LOGIN_LDAP</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"System authentication failed: IOException with server LDAP"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">ERROR_IO_LDAP</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span>

	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="nc">DirContext</span> <span class="nf">connect</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">user</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">hosts</span><span class="o">,</span>
			<span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">adddomain</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">NamingException</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">LoginException</span> <span class="o">{</span>

		<span class="k">if</span> <span class="o">((</span><span class="n">hosts</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">hosts</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"LDAP host cannot be neither null nor empty"</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">EMPTY_LDAP_HOST</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span>

		<span class="nc">StringTokenizer</span> <span class="n">st</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringTokenizer</span><span class="o">(</span><span class="n">hosts</span><span class="o">,</span> <span class="s">";"</span><span class="o">);</span>

		<span class="k">while</span> <span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">hasMoreTokens</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">host</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">nextToken</span><span class="o">();</span>
			<span class="k">return</span> <span class="nf">_connect</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">adddomain</span><span class="o">,</span> <span class="n">ssl</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>

	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="nc">DirContext</span> <span class="nf">_connect</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">user</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">host</span><span class="o">,</span>
			<span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">adddomain</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">NamingException</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">LoginException</span> <span class="o">{</span>

		<span class="nc">Hashtable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Hashtable</span><span class="o">&lt;&gt;();</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"user cannot be neither null nor empty"</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">EMPTY_LDAP_USER</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

		<span class="o">}</span>

		<span class="k">if</span> <span class="o">((</span><span class="n">password</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">password</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"password cannot be neither null nor empty"</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">EMPTY_LDAP_PASSWORD</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

		<span class="o">}</span>

		<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">,</span> <span class="s">"com.sun.jndi.ldap.LdapCtxFactory"</span><span class="o">);</span>
		<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">PROVIDER_URL</span><span class="o">,</span> <span class="s">"ldap://"</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
		<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">SECURITY_AUTHENTICATION</span><span class="o">,</span> <span class="s">"simple"</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">adddomain</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">SECURITY_PRINCIPAL</span><span class="o">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s">"@"</span> <span class="o">+</span> <span class="n">adddomain</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">SECURITY_PRINCIPAL</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">SECURITY_CREDENTIALS</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">ssl</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">SECURITY_PROTOCOL</span><span class="o">,</span> <span class="s">"ssl"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">REFERRAL</span><span class="o">,</span> <span class="s">"follow"</span><span class="o">);</span>
		<span class="nc">DirContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InitialDirContext</span><span class="o">(</span><span class="n">props</span><span class="o">);</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Authentication sucessfully in LDAP"</span><span class="o">);</span>

		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"System authentication failed: wrong user and/or pass in LDAP"</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="nc">LdapError</span><span class="o">.</span><span class="na">LDAP_AUTH_USER_PASS_NOT_VALID</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

		<span class="o">}</span>

		<span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>

	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">extractAndDecodeHeader</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">header</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">base64Token</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">6</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
			<span class="kt">byte</span><span class="o">[]</span> <span class="n">decoded</span><span class="o">;</span>
			<span class="n">decoded</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">base64Token</span><span class="o">);</span>

			<span class="kd">final</span> <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">decoded</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getCredentialsCharset</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
			<span class="kd">final</span> <span class="kt">int</span> <span class="n">delim</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">':'</span><span class="o">);</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">delim</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="s">"Invalid basic authentication token"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">token</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">delim</span><span class="o">),</span> <span class="n">token</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">delim</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">};</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="o">|</span> <span class="nc">UnsupportedEncodingException</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="s">"Failed to decode basic authentication token"</span><span class="o">,</span> <span class="n">error</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getCredentialsCharset</span><span class="o">(</span><span class="kd">final</span> <span class="nc">HttpServletRequest</span> <span class="n">httpRequest</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">credentialsCharset</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

  <p><strong>CustomSecurityAutoConfiguration.java</strong></p>



<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.ontimize.projectwiki.security</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.ConditionalOnProperty</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.ontimize.boot.autoconfigure.security.DefaultSecurityAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ontimize.jee.server.security.authentication.IAuthenticationMechanism</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ontimize.jee.server.security.authentication.OntimizeAuthenticationFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ontimize.jee.server.security.authentication.OntimizeAuthenticationSuccessHandler</span><span class="o">;</span>

<span class="nd">@Configuration</span> 
<span class="nd">@EnableWebSecurity</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ontimize.security.mode"</span><span class="o">,</span> <span class="n">havingValue</span> <span class="o">=</span> <span class="s">"ldap"</span><span class="o">,</span> <span class="n">matchIfMissing</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomSecurityAutoConfiguration</span> <span class="kd">extends</span> <span class="nc">DefaultSecurityAutoConfiguration</span> <span class="o">{</span> 

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${ontimize.security.servicePath:/**}"</span><span class="o">)</span> 
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">servicePath</span><span class="o">;</span> 

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${ontimize.security.ignorePaths:}"</span><span class="o">)</span> 
    <span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">ignorePaths</span><span class="o">;</span> 
 
    <span class="nd">@Override</span> 
    <span class="kd">public</span> <span class="nc">OntimizeAuthenticationFilter</span> <span class="nf">preAuthFilterOntimize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span> 
        <span class="nc">OntimizeAuthenticationFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OntimizeAuthenticationFilter</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">servicePath</span><span class="o">);</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setUserDetailsService</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setUserCache</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">userCache</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setTokenGenerator</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tokenGenerator</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setGenerateJwtHeader</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">authenticationManager</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setAuthenticationEntryPoint</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setAuthenticationMechanismList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span> 
		<span class="n">filter</span><span class="o">.</span><span class="na">getAuthenticationMechanismList</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwtAuthenticator</span><span class="o">());</span>
		<span class="n">filter</span><span class="o">.</span><span class="na">getAuthenticationMechanismList</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">ldapAuthenticator</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">setAuthenticationSuccessHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">OntimizeAuthenticationSuccessHandler</span><span class="o">());</span> 
        <span class="n">filter</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span> 
        <span class="k">return</span> <span class="n">filter</span><span class="o">;</span> 

    <span class="o">}</span> 
  
    <span class="nd">@Bean</span> 
    <span class="kd">public</span> <span class="nc">IAuthenticationMechanism</span> <span class="nf">ldapAuthenticator</span><span class="o">()</span> <span class="o">{</span> 
        <span class="k">return</span> <span class="k">new</span> <span class="nf">LdapAuthenticationMechanism</span><span class="o">();</span> 
    <span class="o">}</span> 
<span class="o">}</span> </code></pre></figure>

</div>
</div>

<h2 id="modify-applicationyml">Modify application.yml</h2>

<h3 id="add-ldap-properties">Add LDAP properties</h3>

<p>In the <em>application.yml</em> we need to change the ontimize security mode to <strong>ldap</strong> and add the following properties (More information in <a href="/ontimize-boot/v1/basics/autoconfigurators/#ldap">this link</a>):</p>

<div class="multiColumnRow">
<div class="multiColumn jstreeloader">
<ul>
  <li data-jstree='{"opened":true, "icon":"fas fa-folder-open"}'>
  ontimize-examples
  <ul>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-api
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  api
                  <ul>
                    <li data-jstree='{"icon":"fas fa-folder-open"}'>
                    core
                    <ul>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      service
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>IUserService.java</li>
                      </ul>
                      </li>
                    </ul>
                    </li>
                  </ul>
                  </li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-boot
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  security
                  <ul>
                    <li data-jstree='{"icon":"fas fa-file"}'>CustomSecurityAutoConfiguration.java</li>
                    <li data-jstree='{"icon":"fas fa-file"}'>LdapAuthenticationMechanism.java</li>
                    <li data-jstree='{"icon":"fas fa-file"}'>LdapError.java</li>
                  </ul>
                  </li>
                  <li data-jstree='{"icon":"fas fa-file"}'>ServerApplication.java</li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          resources
          <ul>
            <li data-jstree='{"selected": true, "icon":"fas fa-file"}'>application.yml</li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-model
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          db
          <ul>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.properties</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.script</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.txt</li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  model
                  <ul>
                    <li data-jstree='{"icon":"fas fa-folder-open"}'>
                    core
                    <ul>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      dao
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserDao.java</li>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserRoleDao.java</li>
                      </ul>
                      </li>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      service
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserService.java</li>
                      </ul>
                      </li>
                    </ul>
                    </li>
                  </ul>
                  </li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          resources
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            dao
            <ul>
              <li data-jstree='{"icon":"fas fa-file"}'>placeholders.properties</li>
              <li data-jstree='{"icon":"fas fa-file"}'>RoleDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>RoleServerPermissionDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>ServerPermissionDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>UserDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>UserRoleDao.xml</li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    projectwiki-ws
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            com
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              ontimize
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                projectwiki
                <ul>
                  <li data-jstree='{"icon":"fas fa-folder-open"}'>
                  ws
                  <ul>
                    <li data-jstree='{"icon":"fas fa-folder-open"}'>
                    core
                    <ul>
                      <li data-jstree='{"icon":"fas fa-folder-open"}'>
                      rest
                      <ul>
                        <li data-jstree='{"icon":"fas fa-file"}'>MainRestController.java</li>
                        <li data-jstree='{"icon":"fas fa-file"}'>TestRestController.java</li>
                        <li data-jstree='{"icon":"fas fa-file"}'>UserRestController.java</li>
                      </ul>
                      </li>
                    </ul>
                    </li>
                  </ul>
                  </li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-file"}'>.gitignore</li>
    <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    <li data-jstree='{"icon":"fas fa-file"}'>README.md</li>
  </ul>
  </li>
</ul>
</div>
<div class="multiColumn multiColumnGrow">

  <p><strong>application.yml</strong></p>


<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="na">ontimize</span><span class="pi">:</span><span class="err">
</span>
   <span class="na">security</span><span class="pi">:</span><span class="err">
</span>
      <span class="na">mode</span><span class="pi">:</span> <span class="s">ldap</span><span class="err">
</span>
<span class="na">ldap</span><span class="pi">:</span> <span class="err">
</span>
   <span class="na">active</span><span class="pi">:</span> <span class="no">true</span><span class="s"> </span><span class="err">
</span>
   <span class="na">host</span><span class="pi">:</span> <span class="s">10.0.0.1</span><span class="err">
</span>
   <span class="na">port</span><span class="pi">:</span> <span class="m">389</span><span class="err">
</span>
   <span class="na">loginType</span><span class="pi">:</span> <span class="s">simple</span><span class="err">
</span>
   <span class="s">bind.dn</span><span class="pi">:</span> <span class="err">
</span>
   <span class="s">base.dn</span><span class="pi">:</span> <span class="err">
</span>
   <span class="na">domain</span><span class="pi">:</span> <span class="s">yourdomain.com</span></code></pre></figure>


</div>
</div>

        
      </section>

      <footer class="page__meta">
        
        


        

      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/imatiainnova" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/company/imatia-innovation/" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-linkedin-in" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://github.com/ontimize/ontimize-boot" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    <li><a href="/ontimize-boot/v1/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">Â© 2021 Imatia Innovation, S.L. Powered by <a href="https://jekyllrb.com" rel="noopener noreferrer" target="_blank">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="noopener noreferrer" target="_blank">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ontimize-boot/v1/assets/js/main.min.js"></script>











  </body>
</html>
